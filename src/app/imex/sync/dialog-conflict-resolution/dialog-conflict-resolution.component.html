<h1 mat-dialog-title>{{ 'F.SYNC.D_CONFLICT_RESOLUTION.TITLE' | translate }}</h1>

<div mat-dialog-content>
  <p>{{ 'F.SYNC.D_CONFLICT_RESOLUTION.INTRO' | translate }}</p>

  @for (conflict of data.conflicts; track conflict.entityId) {
    <div
      class="conflict-item"
      [class.resolved]="getResolution(conflict.entityId)"
    >
      <div class="conflict-header">
        <h3>{{ conflict.entityType }}: {{ conflict.entityId }}</h3>
        @if (getResolution(conflict.entityId)) {
          <mat-icon class="resolved-icon">check_circle</mat-icon>
        }
      </div>

      <div class="conflict-sides">
        <div
          class="local-side"
          [class.selected]="getResolution(conflict.entityId) === 'local'"
        >
          <h4>{{ 'F.SYNC.D_CONFLICT_RESOLUTION.LOCAL' | translate }}</h4>
          <p>
            {{ 'F.SYNC.D_CONFLICT_RESOLUTION.OPS_COUNT' | translate }}
            {{ conflict.localOps.length }}
          </p>
          @if (conflict.localOps.length > 0) {
            <p>
              {{ 'F.SYNC.D_CONFLICT_RESOLUTION.LAST_OP' | translate }}
              {{
                conflict.localOps[conflict.localOps.length - 1].timestamp | date: 'short'
              }}
            </p>
          }
          <button
            mat-stroked-button
            type="button"
            [color]="getResolution(conflict.entityId) === 'local' ? 'primary' : undefined"
            (click)="resolve($index, 'local')"
          >
            @if (getResolution(conflict.entityId) === 'local') {
              <mat-icon>check</mat-icon>
            }
            {{ 'F.SYNC.D_CONFLICT_RESOLUTION.USE_LOCAL' | translate }}
          </button>
        </div>

        <div
          class="remote-side"
          [class.selected]="getResolution(conflict.entityId) === 'remote'"
        >
          <h4>{{ 'F.SYNC.D_CONFLICT_RESOLUTION.REMOTE' | translate }}</h4>
          <p>
            {{ 'F.SYNC.D_CONFLICT_RESOLUTION.OPS_COUNT' | translate }}
            {{ conflict.remoteOps.length }}
          </p>
          @if (conflict.remoteOps.length > 0) {
            <p>
              {{ 'F.SYNC.D_CONFLICT_RESOLUTION.LAST_OP' | translate }}
              {{
                conflict.remoteOps[conflict.remoteOps.length - 1].timestamp
                  | date: 'short'
              }}
            </p>
          }
          <button
            mat-stroked-button
            type="button"
            [color]="
              getResolution(conflict.entityId) === 'remote' ? 'primary' : undefined
            "
            (click)="resolve($index, 'remote')"
          >
            @if (getResolution(conflict.entityId) === 'remote') {
              <mat-icon>check</mat-icon>
            }
            {{ 'F.SYNC.D_CONFLICT_RESOLUTION.USE_REMOTE' | translate }}
          </button>
        </div>
      </div>
    </div>
  }
</div>

<div
  mat-dialog-actions
  align="end"
>
  <button
    mat-button
    (click)="resolveAll('local')"
  >
    {{ 'F.SYNC.D_CONFLICT_RESOLUTION.USE_ALL_LOCAL' | translate }}
  </button>
  <button
    mat-button
    (click)="resolveAll('remote')"
  >
    {{ 'F.SYNC.D_CONFLICT_RESOLUTION.USE_ALL_REMOTE' | translate }}
  </button>
  <button
    mat-flat-button
    color="primary"
    [disabled]="!allResolved()"
    (click)="submitResolutions()"
  >
    {{ 'G.APPLY' | translate }}
  </button>
</div>
